---
#ansible-playbook mybb-stg-app.yml

# Update CentOS

-  name: Update Operating System
   hosts: '*'
   tasks:
     - name: upgrade all packages
       yum:
         name: "*"
         state: latest
         update_cache: true
       become: true
# Create user and group
-  name: Adding bbguser and stackdriver-agent to the instances
   hosts: '*'
   tasks:
     - name: Ensure the group exists
       group:
         name: bbguser
         state: present
       become: true
     - name: Create bbguser user
       user:
         name: bbguser
         #password: P@ssw0rd
         comment: bbguser use for applications
         group: bbguser
       become: true
     # make sure the script agent exist
     - name: Make sure extracted monitoring agent is exists
       stat: path=$HOME/install-monitoring-agent.sh
       register: stack
       become: true
       become_user: bbguser
     # Installing the agent
     - name: Installing agent for monitoring
       command: "{{  item  }}"
       loop:
         - curl -sSO https://dl.google.com/cloudagents/install-monitoring-agent.sh
         - bash install-monitoring-agent.sh
       when: stack.stat.exists == false
       become: true

# Install kafka
-  name: Kafka Installation
   hosts: kafka
   tasks:
     - name: Installing java applications
       yum:
         name: java-1.8.0-openjdk
         state: present
         update_cache: true
       become: true
     - name: Download kafka
       get_url:
         url: https://archive.apache.org/dist/kafka/0.10.1.1/kafka-0.10.1.1-src.tgz
         dest: /home/bbguser
       become: true
       become_user: bbguser
     - name: Make sure extracted kafka is exists
       stat: path=/home/bbguser/kafka
       register: kafka
       become: true
     - name: Extract to a folder
       unarchive:
         src: /home/bbguser/kafka-0.10.1.1-src.tgz
         dest: /home/bbguser
         remote_src: yes
       when: kafka.stat.exists == false
       become: true
       become_user: bbguser
     - name: Rename the extracted directory to kafka
       command: mv /home/bbguser/kafka-0.10.1.1-src /home/bbguser/kafka
       when: kafka.stat.exists == false
       become: true
       become_user: bbguser
     
# MongoDB installation
-  name: MongoDB Installation
   hosts: mongodb
   tasks:
     - name: Add mongodb repository
       copy:
         src: /home/herry.purnama/ansible/mongodb-org-4.2.repo
         dest: /etc/yum.repos.d/mongodb-org-4.2.repo
         owner: root
         group: root
         mode: u=rw,g=r,o=r
       become: true
     - name: Installing MongoDB
       yum:
         name: mongodb-org
         state: present
         update_cache: true
       become: true
     - name: Start the MongoDB server
       service:
         name: mongod 
         state: started
         enabled: yes
         daemon_reload: yes
       become: true
# Docker installation
-  name: Docker Installation
   hosts: '*'
   tasks:
     - name: Installing Docker Prerequisite packages
       yum:
         name:
           - yum-utils
           - device-mapper-persistent-data
           - lvm2
       become: true
     
     - name: Configuring docker-ce repo
       get_url:
         url: https://download.docker.com/linux/centos/docker-ce.repo
         dest: /etc/yum.repos.d/docker-ce.repo
         mode: 0644
       become: true

     - name: Installing Docker
       yum:
         name: docker-ce
         state: present
         update_cache: true
       become: true
     - name: Start the Docker server
       service:
         name: docker 
         state: started
         enabled: yes
         daemon_reload: yes
       become: true

# Redis Installation
-  name: Redis Installation
   hosts: redis
   tasks:
     - name: Installing Redis
       yum:
         name: redis
         state: present
         update_cache: true
       become: true
     - name: Start the Redis server
       service:
         name: redis 
         state: started
         enabled: yes
         daemon_reload: yes
       become: true
       
# Golang Installation
-  name: Golang Installation
   hosts: mybb-poc
   tasks:
     - name: Installing golang
       yum:
         name: golang
         state: latest
         update_cache: true
       become: true

# HAProxy Installation      
-  name: HAProxy Installation
   hosts: mybb-poc
   tasks:
     - name: Installing HAProxy
       yum:
         name: haproxy
         state: present
         update_cache: true
       become: true
     - name: Start the HAProxy server
       service:
         name: haproxy 
         state: started
         enabled: yes
         daemon_reload: yes
       become: true
                
